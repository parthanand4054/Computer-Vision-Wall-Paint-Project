#!/bin/bash
# Save as process_embeddings.sh

# First, extract the payload field from the JSON response
echo "Fetching and processing embeddings..."
RESPONSE=$(curl -s --location 'https://developer.api.us.stg.walmart.com/api-proxy/service/COMPASS/SERVICE/v4/embeddings/upc?upc_id=7062240121' \
--header 'wm_consumer.id: c061c52a-b978-4ae9-9875-6584e58e8a74' \
--header 'Authorization: Bearer eyJraWQiOiJKOTY5MzBhY...')

# Check if the response contains "status":"OK"
if [[ $RESPONSE != *'"status":"OK"'* ]]; then
    echo "Error in API response:"
    echo "$RESPONSE"
    exit 1
fi

# Extract the payload using sed
PAYLOAD=$(echo "$RESPONSE" | sed -n 's/.*"payload":"\([^"]*\)".*/\1/p')

if [ -z "$PAYLOAD" ]; then
    echo "Failed to extract payload from response"
    exit 1
fi

echo "Payload extracted successfully."

# Decode Base64 and decompress
echo "$PAYLOAD" | base64 --decode > embeddings.gz
gunzip -f embeddings.gz

# Check if decompression worked
if [ -f embeddings ]; then
    echo "Successfully decoded and decompressed the payload."
    echo "First few lines of the embeddings:"
    head -n 20 embeddings
    echo "..."
    echo "Full embeddings saved to 'embeddings' file"
else
    echo "Failed to decompress the payload"
    
    # Save the Base64 decoded data for inspection
    echo "$PAYLOAD" | base64 --decode > raw_payload.bin
    echo "Raw decoded payload saved to 'raw_payload.bin'"
fi
